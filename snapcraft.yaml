name: gnome-3-34-1804-sdk
version: git
summary: Shared GNOME 3.34 Ubuntu stack
description: |
 This snap contains only the necessary libraries required by
 GNOME applications.

confinement: strict
grade: stable
base: core18

parts:
  buildenv:
    plugin: nil
    build-environment: &buildenv
      - ACLOCAL_PATH: $SNAPCRAFT_STAGE/usr/share/aclocal
      - XDG_DATA_DIRS: $SNAPCRAFT_STAGE/usr/share:/usr/share:$XDG_DATA_DIRS
      - LD_LIBRARY_PATH: $SNAPCRAFT_STAGE/usr/lib/vala-0.46:$LD_LIBRARY_PATH
      - GDK_PIXBUF_MODULE_FILE: $SNAPCRAFT_STAGE/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/gdk-pixbuf-2.0/2.10.0/loaders.cache

  libtool:
    source: https://git.savannah.gnu.org/git/libtool.git
    plugin: autotools
    configflags: [ --prefix=/usr ]
    build-environment: *buildenv
    build-packages:
      - help2man
      - texinfo
    override-stage: |
      set -eux
      snapcraftctl stage
      LIBTOOLIZE=usr/bin/libtoolize
      sed -i 's#pkgauxdir="#pkgauxdir="$SNAPCRAFT_STAGE#' $LIBTOOLIZE
      sed -i 's#pkgltdldir="#pkgltdldir="$SNAPCRAFT_STAGE#' $LIBTOOLIZE
      sed -i 's#aclocaldir="#aclocaldir="$SNAPCRAFT_STAGE#' $LIBTOOLIZE

  libffi:
    after: [ libtool ]
    source: https://gitlab.freedesktop.org/gstreamer/meson-ports/libffi.git
    source-branch: 'meson'
    source-depth: 1
    plugin: meson
    meson-parameters:
      - --prefix=/usr
      - --buildtype=release
    build-environment: *buildenv

  glib:
    after: [ libffi ]
    source: https://gitlab.gnome.org/GNOME/glib.git
    source-branch: 'glib-2-62'
    source-depth: 1
    plugin: meson
    meson-parameters:
      - --prefix=/usr
      - --buildtype=release
    build-environment: *buildenv
    build-environment:
      - CFLAGS: -Wno-nonnull
    override-build: |
      set -eux
      snapcraftctl build
      mkdir -p $SNAPCRAFT_PART_INSTALL/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/glib-2.0/
      cp $SNAPCRAFT_PART_INSTALL/usr/bin/glib-compile-schemas $SNAPCRAFT_PART_INSTALL/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/glib-2.0/
    build-packages:
      - pkg-config
      - libmount-dev

  pixman:
    after: [ glib ]
    source: https://gitlab.freedesktop.org/pixman/pixman.git
    source-tag: 'pixman-0.38.4'
    source-depth: 1
    plugin: autotools
    configflags: 
      - --prefix=/usr
      - --disable-gtk
    build-environment: *buildenv

  cairo:
    after: [ pixman ]
    source: git://anongit.freedesktop.org/git/cairo
    source-tag: '1.16.0' # see: https://gitlab.freedesktop.org/cairo/cairo/issues/382
    source-depth: 1
    plugin: autotools
    configflags:
      - --prefix=/usr
      - --enable-pdf
      - --enable-ps
      - --enable-xlib
      - --enable-png
      - --enable-tee
      - --enable-svg
      - --enable-xcb
      - --enable-perf-utils
      - --disable-silent-rules
      - --disable-maintainer-mode
      - --disable-gl
    build-environment: *buildenv
    build-packages:
      - libfontconfig1-dev
      - libfreetype6-dev
      - libx11-dev
      - libxext-dev
      - libxcb1-dev
      - libxcb-render0-dev
      - libxcb-shm0-dev
      - libsm-dev
      - zlib1g-dev
      - liblzo2-dev

  gobject-introspection:
    after: [ cairo ]
    source: https://gitlab.gnome.org/GNOME/gobject-introspection.git
    source-branch: 'gnome-3-34'
    source-depth: 1
    plugin: meson
    meson-parameters:
      - --prefix=/usr
      - --buildtype=release
    build-environment: *buildenv
    override-build: |
      set -eux
      snapcraftctl build
      SCANNER=$SNAPCRAFT_PART_INSTALL/usr/bin/g-ir-scanner
      sed -i 's#/usr/lib#$SNAPCRAFT_STAGE/usr/lib#g' $SCANNER
      sed -i 's#/usr/share#$SNAPCRAFT_STAGE/usr/share#g' $SCANNER
    build-packages:
      - python3-dev
      - bison
      - flex

  vala:
    after: [ gobject-introspection ]
    source: https://gitlab.gnome.org/GNOME/vala.git
    source-branch: '0.46'
    plugin: autotools
    configflags: [ --prefix=/usr ]
    build-environment: *buildenv
    build-packages:
      - autoconf-archive
      - valac
      - libgraphviz-dev

  gee: 
    after: [ vala ]
    source: https://gitlab.gnome.org/GNOME/libgee.git
    source-tag: '0.20.2'
    source-depth: 1
    plugin: autotools
    configflags: [ --prefix=/usr ]
    build-environment: *buildenv
    override-build: |
      set -eux
      snapcraftctl build
      GIREPOSITORY_PATH=$SNAPCRAFT_PART_INSTALL/usr/lib/girepository-1.0
      mkdir -p $GIREPOSITORY_PATH
      cp gee/Gee-0.8.typelib $GIREPOSITORY_PATH/
      GIR_PATH=$SNAPCRAFT_PART_INSTALL/usr/share/gir-1.0
      mkdir -p $GIR_PATH
      cp gee/Gee-0.8.gir $GIR_PATH/
      rm -r $SNAPCRAFT_PART_INSTALL/$(echo $SNAPCRAFT_STAGE | cut -d/ -f2)

  atk:
    after: [ gee ]
    source: https://gitlab.gnome.org/GNOME/atk.git
    source-branch: 'gnome-3-34'
    source-depth: 1
    plugin: meson
    meson-parameters: 
      - --prefix=/usr
      - --buildtype=release
      - -Dintrospection=true
      - -Ddocs=false
    build-environment: *buildenv
    override-build: |
      set -eux
      snapcraftctl build
      PC=$SNAPCRAFT_PART_INSTALL/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/pkgconfig/atk.pc
      sed -i 's#exec_prefix=/usr#exec_prefix=${prefix}#' $PC
      sed -i 's#libdir=/usr/lib/$SNAPCRAFT_ARCH_TRIPLET#libdir=${prefix}/lib/$SNAPCRAFT_ARCH_TRIPLET#' $PC
      sed -i 's#includedir=/usr/include#includedir=${prefix}/include#' $PC

  at-spi2-core:
    after: [ atk ]
    source: https://gitlab.gnome.org/GNOME/at-spi2-core.git
    source-tag: 'AT_SPI2_CORE_2_34_0' 
    source-depth: 1
    plugin: meson
    meson-parameters:
      - --prefix=/usr
      - --buildtype=release
      - -Dintrospection=yes
      - -Ddocs=false
    build-environment: *buildenv
    build-packages:
      - libdbus-1-dev
      - libxtst-dev

  at-spi2-atk:
    after: [ at-spi2-core ]
    source: https://gitlab.gnome.org/GNOME/at-spi2-atk.git
    source-tag: 'AT_SPI2_ATK_2_34_1'
    source-depth: 1
    plugin: meson
    meson-parameters:
      - --prefix=/usr
      - --buildtype=release
    build-environment: *buildenv

  fribidi:
    after: [ at-spi2-atk ]
    source: https://github.com/fribidi/fribidi.git
    source-tag: 'v1.0.7'
    source-depth: 1
    plugin: meson
    meson-parameters: 
      - --prefix=/usr
      - --buildtype=release
      - -Ddocs=false
    build-environment: *buildenv

  harfbuzz:
    after: [ fribidi ]
    source: https://github.com/harfbuzz/harfbuzz.git
    source-tag: '2.6.2'
    source-depth: 1
    plugin: autotools
    configflags:
      - --prefix=/usr
      - --with-graphite2=yes
      - --enable-introspection
      - --with-gobject
      - --enable-static
    build-environment: *buildenv
    override-build: |
      set -eux
      snapcraftctl build
      PC=$SNAPCRAFT_PART_INSTALL/usr/lib/pkgconfig/harfbuzz.pc
      sed -i 's#exec_prefix=/usr#exec_prefix=${prefix}#' $PC
      sed -i 's#libdir=/usr#libdir=${prefix}#' $PC
      sed -i 's#includedir=/usr#includedir=${prefix}#' $PC
    build-packages:
      - ragel

  pango:
    after: [ harfbuzz ]
    source: https://gitlab.gnome.org/GNOME/pango.git
    source-tag: '1.44.6-2'
    source-depth: 1
    plugin: meson
    meson-parameters:
      - --prefix=/usr
      - --buildtype=release
      - -Dinstall-tests=false
      - -Dgtk_doc=false
      - -Dgir=true
    build-environment: *buildenv
    build-packages:
      - libthai-dev
      - libxft-dev
      - libxrender-dev
      - libxt-dev
      - cmake

  librsvg:
    after: [ pango ]
    source: https://gitlab.gnome.org/GNOME/librsvg.git
    source-branch: 'librsvg-2.44'
    source-depth: 1
    plugin: autotools
    configflags: [ --prefix=/usr ]
    build-environment: *buildenv
    build-packages:
      - cargo
      - libcroco3-dev

  gdk-pixbuf:
    after: [ librsvg ]
    source: https://gitlab.gnome.org/GNOME/gdk-pixbuf.git
    source-branch: 'gdk-pixbuf-2-38'
    source-depth: 1
    plugin: meson
    meson-parameters:
     - --prefix=/usr
     - --buildtype=release
     - -Dinstalled_tests=false
    build-environment: *buildenv
    override-build: |
      set -eux
      snapcraftctl build
      LOADERS_PATH=$SNAPCRAFT_PART_INSTALL/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/gdk-pixbuf-2.0/2.10.0/loaders
      $SNAPCRAFT_PART_INSTALL/usr/bin/gdk-pixbuf-query-loaders $LOADERS_PATH/*.so > $LOADERS_PATH.cache
    organize:
      usr/bin/gdk-pixbuf-query-loaders: usr/lib/$SNAPCRAFT_ARCH_TRIPLET/gdk-pixbuf-2.0/gdk-pixbuf-query-loaders
    build-packages:
      - libpng-dev
      - libjpeg-dev
      - libtiff-dev

  epoxy:
    after: [ gdk-pixbuf ]
    source: https://github.com/anholt/libepoxy.git
    source-tag: '1.5.3'  # Note minor version of tag/branch can be even or odd and be stable
    source-depth: 1
    plugin: meson
    meson-parameters:
     - --prefix=/usr
     - --buildtype=release
    build-environment: *buildenv
    build-packages:
      - libgl1-mesa-dev
      - libegl1-mesa-dev
      - xutils-dev

  json-glib: 
    after: [ epoxy ]
    source: https://gitlab.gnome.org/GNOME/json-glib.git
    source-branch: 'json-glib-1-4'
    source-depth: 1
    plugin: meson
    meson-parameters:
      - --prefix=/usr
      - --buildtype=release
      - -Dgtk_doc=disabled
    build-environment: *buildenv

  libpsl:
    after: [ json-glib ]
    source: https://github.com/rockdaboot/libpsl.git
    source-tag: 'libpsl-0.21.0'
    source-depth: 1
    plugin: autotools
    configflags:
      - --prefix=/usr
      - --enable-runtime=libidn2
    build-environment: *buildenv
    build-packages:
      - libidn2-0-dev
      - libunistring-dev

  libsoup:
    after: [ libpsl ]
    source: https://gitlab.gnome.org/GNOME/libsoup.git
    source-tag: '2.68.2'   # not a gnome-3-34 branch yet
    source-depth: 1
    plugin: meson
    meson-parameters: 
      - --prefix=/usr
      - --buildtype=release
      - -Dvapi=enabled
    build-environment: *buildenv
    build-packages:
      - libsqlite3-dev
      - libkrb5-dev
      - libbrotli-dev

  librest:
    after: [ libsoup ]
    source: https://gitlab.gnome.org/GNOME/librest.git
    source-branch: 'librest-0-7'  # looks like this branch has been updated more recently than the 0.8 tags - weird
    source-depth: 1
    plugin: autotools
    configflags: [ --prefix=/usr ]
    build-environment: *buildenv
    build-packages:
      - gtk-doc-tools

  wayland-protocols:
    after: [ librest ]
    source: https://gitlab.freedesktop.org/wayland/wayland-protocols.git
    source-tag: '1.20'
    source-depth: 1
    plugin: autotools
    configflags: [ --prefix=/usr ]
    build-environment: *buildenv

  gtk:
    after: [ wayland-protocols ]
    source: https://gitlab.gnome.org/GNOME/gtk.git
    source-tag: '3.24.11'
    #source-branch: gtk-3-24
    source-depth: 1
    plugin: meson
    meson-parameters:
      - --prefix=/usr
      - --buildtype=debug
      - -Dbroadway_backend=true
      - -Dx11_backend=true
      - -Dwayland_backend=true
      - -Dwin32_backend=false
      - -Dquartz_backend=false
      - -Dxinerama=yes
      - -Dintrospection=true
      - -Dbuiltin_immodules=yes
      - -Ddemos=false
      - -Dexamples=false
    build-environment: *buildenv
    organize:
      usr/lib/gtk-3.0: usr/lib/$SNAPCRAFT_ARCH_TRIPLET/gtk-3.0
      usr/bin/gtk-query-immodules-3.0: usr/lib/$SNAPCRAFT_ARCH_TRIPLET/libgtk-3-0/gtk-query-immodules-3.0
    build-packages:
      - libwayland-dev
      - wayland-protocols
      - libxkbcommon-dev
      - libxinerama-dev
      - libcups2-dev
      - libcolord-dev
      - libxrandr-dev
      - libxcursor-dev
      - libisocodes-dev
      - libxcomposite-dev
      - libxdamage-dev
      - libxfixes-dev
      - libxi-dev
      - libxkbfile-dev
      - libxml2-utils

  gtk-locales:
    after: [ gtk ]
    plugin: nil
    override-pull: |
      set -eux
      apt download "language-pack-gnome-*-base"
    override-build: |
      set -eux
      for deb in *.deb; do dpkg-deb -x $deb .; done
      find usr/share/locale-langpack -type f -not -name "gtk30*.mo" -exec rm '{}' \;
      mkdir -p $SNAPCRAFT_PART_INSTALL/usr/share
      cp -r usr/share/locale-langpack $SNAPCRAFT_PART_INSTALL/usr/share/

  mm-common:
    after: [ gtk-locales ]
    source: https://gitlab.gnome.org/GNOME/mm-common.git
    source-tag: '1.0.0'
    plugin: meson
    meson-parameters:
      - --prefix=/usr
      - -Duse-network=true
    override-build: |
      set -eux
      snapcraftctl build
    build-environment: *buildenv
    build-packages:
      - wget

  glibmm:
    after: [ mm-common ]
    source: https://gitlab.gnome.org/GNOME/glibmm.git
    source-tag: '2.62.0'
    plugin: autotools
    override-build: |
      set -eux
    
      # Make sure all of the *.am files from mm-common are found
      mkdir -p /usr/bin
      mkdir -p /usr/share/mm-common/build/
      mkdir -p /usr/share/mm-common/doctool/
      cp $SNAPCRAFT_STAGE/usr/bin/mm-common-prepare /usr/bin/mm-common-prepare
      cp $SNAPCRAFT_STAGE/usr/share/mm-common/build/*.am /usr/share/mm-common/build/
      cp $SNAPCRAFT_STAGE/usr/share/mm-common/doctool/* /usr/share/mm-common/doctool/

      # Manual build of glibmm
      cd $SNAPCRAFT_PART_BUILD
      ./autogen.sh --prefix=/usr
      make -j8
      make install DESTDIR=$SNAPCRAFT_PART_INSTALL
    build-packages:
      - libsigc++-2.0-dev
    build-environment: *buildenv
    
  cairomm:
    after: [ glibmm ]
    source: https://gitlab.freedesktop.org/cairo/cairomm.git
    source-tag: 'v1.12.2'
    plugin: autotools
    override-build: |
      set -eux
      cd $SNAPCRAFT_PART_BUILD
      ./autogen.sh --prefix=/usr
      make -j8
      make install DESTDIR=$SNAPCRAFT_PART_INSTALL
    configflags: [ --prefix=/usr ]
    build-environment: *buildenv

  pangomm:
    after: [ cairomm ]
    source: https://gitlab.gnome.org/GNOME/pangomm.git
    source-tag: '2.42.0'
    plugin: autotools
    configflags: 
      - --prefix=/usr
      - --enable-maintainer-mode
    build-environment:
      - PKG_CONFIG_PATH: $SNAPCRAFT_STAGE/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/pkgconfig:$SNAPCRAFT_STAGE/usr/lib/$SNAPCRAFT_ARCH_TRIPLET:$PKG_CONFIG_PATH
      - ACLOCAL_PATH: $SNAPCRAFT_STAGE/usr/share/aclocal
      - XDG_DATA_DIRS: $SNAPCRAFT_STAGE/usr/share:/usr/share:$XDG_DATA_DIRS
      - LD_LIBRARY_PATH: $SNAPCRAFT_STAGE/usr/lib/vala-0.46:$LD_LIBRARY_PATH
      - GDK_PIXBUF_MODULE_FILE: $SNAPCRAFT_STAGE/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/gdk-pixbuf-2.0/2.10.0/loaders.cache
      - M4PATH: $SNAPCRAFT_STAGE/usr/lib/glibmm-2.4/proc/m4

  atkmm:
    after: [ pangomm ]
    source: https://gitlab.gnome.org/GNOME/atkmm.git
    source-tag: '2.28.0'
    plugin: autotools
    override-build: |
      set -eux
      cd $SNAPCRAFT_PART_BUILD
      ./autogen.sh --prefix=/usr
      make -j8
      make install DESTDIR=$SNAPCRAFT_PART_INSTALL
    build-environment: 
      - ACLOCAL_PATH: $SNAPCRAFT_STAGE/usr/share/aclocal
      - XDG_DATA_DIRS: $SNAPCRAFT_STAGE/usr/share:/usr/share:$XDG_DATA_DIRS
      - LD_LIBRARY_PATH: $SNAPCRAFT_STAGE/usr/lib/vala-0.46:$LD_LIBRARY_PATH
      - GDK_PIXBUF_MODULE_FILE: $SNAPCRAFT_STAGE/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/gdk-pixbuf-2.0/2.10.0/loaders.cache
      - M4PATH: $SNAPCRAFT_STAGE/usr/lib/glibmm-2.4/proc/m4

  gtkmm:
    after: [ atkmm ]
    source: https://gitlab.gnome.org/GNOME/gtkmm.git
    source-tag: '3.24.2'
    plugin: autotools
    configflags: [ --prefix=/usr ]
    override-build: |
      set -eux
      cd $SNAPCRAFT_PART_BUILD
      ./autogen.sh --prefix=/usr
      make -j8
      make install DESTDIR=$SNAPCRAFT_PART_INSTALL
    build-environment: 
      - PKG_CONFIG_PATH: $SNAPCRAFT_STAGE/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/pkgconfig:$SNAPCRAFT_STAGE/usr/lib/$SNAPCRAFT_ARCH_TRIPLET:$PKG_CONFIG_PATH
      - ACLOCAL_PATH: $SNAPCRAFT_STAGE/usr/share/aclocal
      - XDG_DATA_DIRS: $SNAPCRAFT_STAGE/usr/share:/usr/share:$XDG_DATA_DIRS
      - LD_LIBRARY_PATH: $SNAPCRAFT_STAGE/usr/lib/vala-0.46:$LD_LIBRARY_PATH
      - GDK_PIXBUF_MODULE_FILE: $SNAPCRAFT_STAGE/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/gdk-pixbuf-2.0/2.10.0/loaders.cache
      - M4PATH: $SNAPCRAFT_STAGE/usr/lib/glibmm-2.4/proc/m4
    build-packages:
      - gtk-doc-tools

  gtksourceview:
    after: [ gtkmm ]
    source: https://gitlab.gnome.org/GNOME/gtksourceview.git
    source-tag: '4.4.0'
    source-depth: 1
    plugin: meson
    meson-parameters:
     - --prefix=/usr
     - --buildtype=release
    build-environment: *buildenv
    build-packages:
      - gettext
      - libxml2-dev

  libdazzle:
    after: [ gtksourceview ]
    source: https://gitlab.gnome.org/GNOME/libdazzle.git
    source-branch: 'libdazzle-3-34'
    source-depth: 1
    plugin: meson
    meson-parameters:
     - --prefix=/usr
     - --buildtype=release
    build-environment: *buildenv

  libcanberra: 
    after: [ libdazzle ]
    source: git://git.0pointer.net/libcanberra.git
    source-depth: 1
    plugin: autotools
    configflags: [ --prefix=/usr ]
    build-environment: *buildenv
    build-packages:
      - libasound2-dev
      - libvorbis-dev
      - libtdb-dev
      - libpulse-dev
      - libgstreamer1.0-dev

  gsettings-desktop-schemas:
    after: [ libcanberra ]
    source: https://gitlab.gnome.org/GNOME/gsettings-desktop-schemas.git
    source-branch: 'gnome-3-34'
    source-depth: 1
    plugin: meson
    meson-parameters:
     - --prefix=/usr
     - --buildtype=release
    build-environment: *buildenv
    override-build: |
      set -eux
      snapcraftctl build
      PC=$SNAPCRAFT_PART_INSTALL/usr/share/pkgconfig/gsettings-desktop-schemas.pc
      sed -i 's#-I/usr#-I${prefix}#' $PC

  gnome-desktop:
    after: [ gsettings-desktop-schemas ]
    source: https://gitlab.gnome.org/GNOME/gnome-desktop.git
    source-branch: 'gnome-3-34'
    source-depth: 1
    plugin: meson
    meson-parameters:
     - --prefix=/usr
     - --buildtype=release
    build-environment: *buildenv
    build-packages:
      - iso-codes
      - itstool
      - libseccomp-dev
      - libudev-dev
      - xkb-data
      - yelp-tools

  cogl:
    after: [ gnome-desktop ]
    source: https://gitlab.gnome.org/GNOME/cogl.git
    source-branch: 'cogl-1.22'
    source-depth: 1
    plugin: autotools
    configflags: 
      - --prefix=/usr
      - --enable-wayland-egl-platform=yes
    build-environment: *buildenv
    build-packages:
      - libgbm-dev
      - libgles2-mesa-dev
      - xauth
      - xvfb
      - libgstreamer-plugins-base1.0-dev

  clutter:
    after: [ cogl ]
    source: https://gitlab.gnome.org/GNOME/clutter.git
    source-commit: 09788c786f832deec2ae5d9e7b468e7ee0df112d 
    plugin: meson
    meson-parameters:
      - --prefix=/usr
      - --buildtype=release
      - -Dbuild_examples=false
      - -Ddocumentation=false
      - -Dbuild_tests=false
      - -Dpixbuf_tests=false
    build-environment: *buildenv
    build-packages:
      - libdrm-dev
      - xsltproc
      - libinput-dev
      - libgudev-1.0-dev

  clutter-gtk:
    after: [ clutter ]
    source: https://gitlab.gnome.org/GNOME/clutter-gtk.git
    source-tag: '1.8.4'  # ancient tag. should just build from master since it gets updates (like clutter)
    source-depth: 1
    plugin: meson
    meson-parameters:
     - --prefix=/usr
     - --buildtype=release
    build-environment: *buildenv

  libpeas:
    after: [ clutter-gtk ]
    source: https://gitlab.gnome.org/GNOME/libpeas.git
    source-tag: 'libpeas-1.22.0'
    source-depth: 1
    plugin: autotools
    configflags:
      - --prefix=/usr
      - --enable-python2
      - --enable-python3
    build-environment: *buildenv
    build-packages:
      - gnome-pkg-tools
      - gnome-common
      - intltool
      - libgladeui-dev
      - python-dev
      - python-gi-dev
      - adwaita-icon-theme

  pycairo:
    after: [ libpeas ]
    source: https://github.com/pygobject/pycairo.git
    source-tag: 'v1.18.1'
    source-depth: 1
    plugin: meson
    meson-parameters:
     - --prefix=/usr
     - --buildtype=release
    build-environment: *buildenv

  pygobject:
    after: [ pycairo ]
    source: https://gitlab.gnome.org/GNOME/pygobject.git
    source-branch: 'pygobject-3-34'
    source-depth: 1
    plugin: meson
    meson-parameters:
     - --prefix=/usr
     - --buildtype=release
    build-environment: *buildenv

  libhandy:
    after: [ pygobject ]
    source: https://source.puri.sm/Librem5/libhandy.git
    source-branch: 'libhandy-0-0'
    source-depth: 1
    plugin: meson
    meson-parameters:
      - --prefix=/usr
      - --buildtype=release
      - -Dgtk_doc=false
      - -Dtests=false
      - -Dexamples=false
      - -Dglade_catalog=disabled
    build-environment: *buildenv

  debs:
    after: [ libhandy ]
    plugin: nil
    stage-packages:
      - pkg-config
      - libpcre3-dev
      - zlib1g-dev
      - libmount-dev
      - libxml2-dev
      - libsqlite3-dev
      - libbrotli-dev
      - libthai-dev
      - libfontconfig1-dev
      - libxrender-dev
      - libxft-dev
      - libxcb-shm0-dev
      - libxcb-render0-dev
      - libxext-dev
      - libxi-dev
      - libxrandr-dev
      - libxcursor-dev
      - libxcomposite-dev
      - libxdamage-dev
      - libxinerama-dev
      - libwayland-dev
      - wayland-protocols
      - libxkbcommon-dev
      - libgl1-mesa-dev
      - libegl1-mesa-dev
      - libdbus-1-dev
      - libxtst-dev
      - gettext
      - shared-mime-info
      - libwebkit2gtk-4.0-dev
      - libgcr-3-dev
      - libnotify-dev
      - libsecret-1-dev
      - itstool
      - libudev-dev
      - libseccomp-dev
      - libjpeg-dev
      - liblcms2-dev
      - libgspell-1-dev
      - python3-minimal
      - libxml2-utils
      - libgtksourceview-3.0-dev
      - libtdb1
      - libvorbisfile3
      - libegl-mesa0
    override-build: |
      set -eux
      snapcraftctl build
      cd $SNAPCRAFT_STAGE/usr
      find . -type f,l -exec rm -f $SNAPCRAFT_PART_INSTALL/usr/{} \;
      find . -type f,l -name "*.so*" -exec bash -c "rm -f $SNAPCRAFT_PART_INSTALL/usr/{}*" \;
      cd $SNAPCRAFT_STAGE/usr/lib
      find . -type f,l -exec rm -f $SNAPCRAFT_PART_INSTALL/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/{} \;
      find . -type f,l -name "*.so*" -exec bash -c "rm -f $SNAPCRAFT_PART_INSTALL/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/{}*" \;
      cd $SNAPCRAFT_STAGE/usr/lib/$SNAPCRAFT_ARCH_TRIPLET
      find . -type f,l -exec rm -f $SNAPCRAFT_PART_INSTALL/usr/lib/{} \;
      find . -type f,l -name "*.so*" -exec bash -c "rm -f $SNAPCRAFT_PART_INSTALL/usr/lib/{}*" \;

  conditioning:
    after: [ debs ]
    plugin: nil
    build-environment: *buildenv
    override-prime: |
      set -eux
      snapcraftctl prime

      glib-compile-schemas usr/share/glib-2.0/schemas
      update-mime-database usr/share/mime
      for dir in usr/share/icons/*; do
        if [ -f "$dir/index.theme" ]; then
          gtk-update-icon-cache --force "$dir"
        fi
      done

      for PC in $(find . -path "*/pkgconfig/*.pc")
      do
        sed -i 's#prefix=$SNAPCRAFT_STAGE#prefix=/snap/$SNAPCRAFT_PROJECT_NAME/current#' $PC
        sed -i 's#prefix = /usr#prefix=/snap/$SNAPCRAFT_PROJECT_NAME/current/usr#' $PC
        sed -i 's#prefix=/usr#prefix=/snap/$SNAPCRAFT_PROJECT_NAME/current/usr#' $PC
        sed -i 's#original_prefix=/snap/$SNAPCRAFT_PROJECT_NAME/current/usr#original_prefix=/usr#' $PC

        sed -i 's#libdir=/usr#libdir=${prefix}#' $PC
        sed -i 's#libdir=/lib#libdir=/snap/$SNAPCRAFT_PROJECT_NAME/current/lib#' $PC

        sed -i 's#exec_prefix=/usr#exec_prefix=${prefix}#' $PC
        sed -i 's#includedir=/usr#includedir=${prefix}#' $PC
        sed -i 's#sysconfdir=/etc#sysconfdir=/snap/$SNAPCRAFT_PROJECT_NAME/current/etc#' $PC
        
        sed -i 's#/usr/#/snap/$SNAPCRAFT_PROJECT_NAME/current/usr/#g' $PC
        sed -i 's#/etc/#/snap/$SNAPCRAFT_PROJECT_NAME/current/etc/#g' $PC
      done

      sed -i 's#/usr/bin/python#python3#' usr/bin/glib-mkenums

      LIBTOOLIZE=usr/bin/libtoolize
      sed -i 's#pkgauxdir="$SNAPCRAFT_STAGE#pkgauxdir="/snap/$SNAPCRAFT_PROJECT_NAME/current#' $LIBTOOLIZE
      sed -i 's#pkgltdldir="$SNAPCRAFT_STAGE#pkgltdldir="/snap/$SNAPCRAFT_PROJECT_NAME/current#' $LIBTOOLIZE
      sed -i 's#aclocaldir="$SNAPCRAFT_STAGE#aclocaldir="/snap/$SNAPCRAFT_PROJECT_NAME/current#' $LIBTOOLIZE

      SCANNER=usr/bin/g-ir-scanner
      sed -i 's#$SNAPCRAFT_STAGE#/snap/$SNAPCRAFT_PROJECT_NAME/current#g' $SCANNER

      ITSTOOL=usr/bin/itstool
      sed -i 's#/usr/local/share#/snap/$SNAPCRAFT_PROJECT_NAME/current/usr/local/share#g' $ITSTOOL
      sed -i 's#/usr/share#/snap/$SNAPCRAFT_PROJECT_NAME/current/usr/share#g' $ITSTOOL

      LOADERS=usr/lib/$SNAPCRAFT_ARCH_TRIPLET/gdk-pixbuf-2.0/2.10.0/loaders.cache
      sed -i 's#/root/parts/gdk-pixbuf/install#/snap/$SNAPCRAFT_PROJECT_NAME/current#g' $LOADERS
      sed -i 's#/build/$SNAPCRAFT_PROJECT_NAME/parts/gdk-pixbuf/install#/snap/$SNAPCRAFT_PROJECT_NAME/current#g' $LOADERS

      XML2_CONFIG=usr/bin/xml2-config
      sed -i 's#/root/parts/debs/install#/snap/$SNAPCRAFT_PROJECT_NAME/current#g' $XML2_CONFIG

      ln -s vala-0.46 usr/lib/vala-current
      ln -s gettext-0.19.8 usr/share/gettext-current
      ln -s gdk-pixbuf-2.0/2.10.0 usr/lib/$SNAPCRAFT_ARCH_TRIPLET/gdk-pixbuf-current

  cleanup:
    after: [ conditioning ]
    plugin: nil
    override-prime: |
      set -eux

      rm -rf usr/share/doc
      rm -rf usr/share/man

      find . -type d -empty -delete
